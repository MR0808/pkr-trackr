// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client"
  output   = "../generated/prisma"
}

datasource db {
  provider = "postgresql"
}

/*
  ============================
  ENUMS
  ============================
*/

enum UserStatus {
  ACTIVE
  DEACTIVATED
}

enum Gender {
  MALE
  FEMALE
  OTHER
  NOTSAY
}

enum GroupRole {
  OWNER
  ADMIN
  MEMBER
}

enum GameStatus {
  OPEN
  CLOSED
}

enum InviteType {
  GROUP_JOIN
  PLAYER_CLAIM
}

enum InviteStatus {
  PENDING
  ACCEPTED
  REVOKED
  EXPIRED
}

/*
  ============================
  USER (Better-Auth compatible)
  ============================
*/

model User {
  id        String  @id @default(uuid())
  name                 String    // Required by Better Auth, auto-populated from firstName + lastName
  firstName            String
  lastName             String
  email                String
  emailVerified        Boolean   @default(false)
  emailVerifiedAt      DateTime?
  status               UserStatus @default(ACTIVE)
  image                String?
  isAdmin              Boolean   @default(false)
  createdAt            DateTime  @default(now())
  updatedAt            DateTime  @updatedAt
  sessions             Session[]
  accounts             Account[]

  // Optional profile fields
  gender        Gender?
  dateOfBirth   DateTime?
  phoneNumber   String?   @unique
  phoneVerified Boolean   @default(false)
  bio           String?

  // Geo preferences (safe deletes!)
  countryId String?
  regionId  String?

  country Country? @relation(fields: [countryId], references: [id], onDelete: SetNull)
  region  Region?  @relation(fields: [regionId], references: [id], onDelete: SetNull)

  // Relationships
  groupsOwned Group[]       @relation("GroupOwner")
  memberships GroupMember[]
  players     Player[]
  invitesSent GroupInvite[] @relation("InvitesSent")

  // Better Auth / verification back-relations
  verifications              Verification[]
  emailVerificationChallenges EmailVerificationChallenge[]
  emailChangeRecords         EmailChangeRecord[]
  phoneChangeRecords         PhoneChangeRecord[]

  @@unique([email])
  @@map("users")
}

model Session {
  id        String   @id @default(uuid())
  expiresAt DateTime
  token     String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  ipAddress String?
  userAgent String?
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([token])
  @@index([userId])
  @@map("sessions")
}

model Account {
  id                    String    @id @default(uuid())
  accountId             String
  providerId            String
  userId                String
  user                  User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  accessToken           String?
  refreshToken          String?
  idToken               String?
  accessTokenExpiresAt  DateTime?
  refreshTokenExpiresAt DateTime?
  scope                 String?
  password              String?
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt

  @@index([userId])
  @@map("accounts")
}

model Verification {
  id         String    @id
  identifier String
  value      String
  expiresAt  DateTime
  createdAt  DateTime?
  updatedAt  DateTime?

  userId String?
  user   User?   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([identifier])
  @@index([expiresAt])
  @@index([userId])
  @@map("verifications")
}

model VerificationToken {
  identifier String
  token      String
  expires    DateTime

  @@id([identifier, token])
  @@map("verification_tokens")
}

model EmailVerificationChallenge {
  id             String   @id @default(cuid())
  userId         String
  email          String

  magicTokenHash String
  otpHash        String

  magicExpiresAt DateTime
  otpExpiresAt   DateTime

  otpAttempts    Int      @default(0)

  sendCount      Int      @default(0)
  lastSentAt     DateTime?

  usedAt         DateTime?
  revokedAt      DateTime?

  createdAt      DateTime @default(now())
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([email])
  @@map("email_verification_challenges")
}

model EmailChangeRecord {
  id        String   @id @default(cuid())
  email     String
  newEmail  String   @map("new_email")
  otp       String
  expiresAt DateTime @map("expires_at")
  attempts  Int      @default(0)
  createdAt DateTime @default(now()) @map("created_at")

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([expiresAt])
  @@map("email_change_records")
}

model PhoneChangeRecord {
  id             String   @id @default(cuid())
  phoneNumber    String?
  newPhoneNumber String
  otp            String
  expiresAt      DateTime @map("expires_at")
  attempts       Int      @default(0)
  createdAt      DateTime @default(now())

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([otp])
  @@index([expiresAt])
  @@map("phone_change_records")
}

model Continent {
  id        String    @id @default(cuid())
  name      String    @unique
  countries Country[]

  @@map("continents")
}

model Country {
  id          String  @id @default(cuid())
  isoCode     String  @unique // ISO 3166-1 alpha-2
  isoCode3    String  @unique // ISO 3166-1 alpha-3
  name        String
  flag        String
  latitude    Float
  longitude   Float
  continentId String
  phonePrefix String?

  continent Continent @relation(fields: [continentId], references: [id], onDelete: Restrict)

  regions Region[]
  users   User[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("countries")
}

model Region {
  id        String @id @default(cuid())
  code      String
  name      String
  countryId String

  country Country @relation(fields: [countryId], references: [id], onDelete: Restrict)
  users   User[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([countryId, code])
  @@map("regions")
}

/* ============================
   GROUP / LEAGUE
   ============================ */

model Group {
  id        String   @id @default(cuid())
  name      String
  slug      String   @unique

  ownerId  String
  owner    User     @relation("GroupOwner", fields: [ownerId], references: [id])

  players  Player[]
  games    Game[]
  seasons  Season[]
  members  GroupMember[]
  invites  GroupInvite[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  @@map("groups")
}

/* ============================
   GROUP MEMBERSHIP
   ============================ */

model GroupMember {
  id      String    @id @default(cuid())
  groupId String
  userId  String
  role    GroupRole @default(MEMBER)

  group   Group     @relation(fields: [groupId], references: [id], onDelete: Cascade)
  user    User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@unique([groupId, userId])
  @@map("group_members")
}

/* ============================
   PLAYER (Reusable Identity)
   ============================ */

model Player {
  id        String   @id @default(cuid())
  groupId   String
  name      String

  email     String?
  userId    String?

  group     Group    @relation(fields: [groupId], references: [id], onDelete: Cascade)
  user      User?    @relation(fields: [userId], references: [id], onDelete: SetNull)

  games       GamePlayer[]
  seasonStats SeasonPlayerStats[]
  invites     GroupInvite[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([groupId, name])
  @@unique([groupId, email])
  @@index([groupId])
  @@index([email])
  @@map("players")
}

/* ============================
   SEASON
   ============================ */

model Season {
  id        String   @id @default(cuid())
  groupId   String
  name      String
  startsAt  DateTime
  endsAt    DateTime?
  isLocked  Boolean  @default(false)

  group     Group    @relation(fields: [groupId], references: [id], onDelete: Cascade)
  games     Game[]
  stats     SeasonPlayerStats[]

  createdAt DateTime @default(now())

  @@unique([groupId, name])
  @@index([groupId])
  @@map("seasons")
}

/* ============================
   GAME (Poker Night)
   ============================ */

model Game {
  id        String     @id @default(cuid())
  groupId   String
  seasonId  String?

  name      String
  status    GameStatus @default(OPEN)

  // NEW: planned start time (what you enter when creating)
  scheduledAt DateTime

  // Actual start (optional, you can set it when the game actually begins)
  startedAt  DateTime?

  closedAt   DateTime?

  shareId   String     @unique

  group     Group      @relation(fields: [groupId], references: [id], onDelete: Cascade)
  season    Season?    @relation(fields: [seasonId], references: [id], onDelete: SetNull)
  players   GamePlayer[]

  createdAt DateTime   @default(now())

  @@index([groupId])
  @@index([seasonId])
  @@index([scheduledAt])
  @@map("games")
}

/* ============================
   GAME PLAYER (Per-Night Stats)
   ============================ */

model GamePlayer {
  id        String   @id @default(cuid())
  gameId    String
  playerId  String

  buyInCents      Int  @default(0)
  cashOutCents    Int?
  adjustmentCents Int  @default(0)

  game     Game     @relation(fields: [gameId], references: [id], onDelete: Cascade)
  player   Player   @relation(fields: [playerId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([gameId, playerId])
  @@index([gameId])
  @@map("game_players")
}

/* ============================
   SEASON PLAYER STATS
   (Cached leaderboard rollups)
   ============================ */

model SeasonPlayerStats {
  id        String   @id @default(cuid())
  seasonId  String
  playerId  String

  totalBuyInCents   Int @default(0)
  totalCashOutCents Int @default(0)
  totalProfitCents  Int @default(0)
  totalGames        Int @default(0)

  season   Season   @relation(fields: [seasonId], references: [id], onDelete: Cascade)
  player   Player   @relation(fields: [playerId], references: [id], onDelete: Cascade)

  updatedAt DateTime @updatedAt

  @@unique([seasonId, playerId])
  @@index([seasonId])
  @@map("season_player_stats")
}

/* ============================
   INVITES
   ============================ */

model GroupInvite {
  id          String       @id @default(cuid())
  groupId     String

  type        InviteType
  role        GroupRole?

  email       String
  playerId    String?

  tokenHash   String       @unique
  status      InviteStatus @default(PENDING)

  createdById String?
  createdBy   User?        @relation("InvitesSent", fields: [createdById], references: [id], onDelete: SetNull)

  createdAt   DateTime     @default(now())
  sentAt      DateTime?
  expiresAt   DateTime
  acceptedAt  DateTime?
  revokedAt   DateTime?

  group       Group        @relation(fields: [groupId], references: [id], onDelete: Cascade)
  player      Player?      @relation(fields: [playerId], references: [id], onDelete: Cascade)

  @@unique([groupId, type, email, playerId])
  @@index([groupId, status])
  @@index([email])
  @@index([expiresAt])
  @@map("group_invites")
}